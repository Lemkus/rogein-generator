name: Deploy to REG.RU Hosting

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key (base64)
        run: |
          echo "${{ secrets.VPS_SSH_KEY_B64 }}" | base64 -d > key.pem
          chmod 600 key.pem

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        env:
          SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          PORT_OPT=${SSH_PORT:+-p $SSH_PORT}
          echo "ðŸ” SSH Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:"
          echo "  Host: ${{ secrets.VPS_HOST }}"
          echo "  User: ${{ secrets.VPS_USER }}"
          echo "  Port: ${{ secrets.VPS_SSH_PORT }}"
          echo "  Path: ${{ secrets.VPS_PATH }}"
          echo "ðŸ” Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ SSH ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ..."
          ssh -i key.pem $PORT_OPT ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'SSH ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!'"
          echo "ðŸ” ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· SSH..."
          ssh -i key.pem $PORT_OPT ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            echo '=== ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° REG.RU Ñ…Ð¾ÑÑ‚Ð¸Ð½Ð³ ==='
            echo 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: \$(whoami)'
            echo 'UID: \$(id -u)'
            echo 'Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: \$(pwd)'
            
            # Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            mkdir -p \"$VPS_PATH\"
            cd \"$VPS_PATH\"
            echo 'Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: \$(pwd)'
            
            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            echo '=== Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ==='
            pip3 install --user uvicorn fastapi flask requests
            
            # ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´
            if [ ! -d \".git\" ]; then
              echo '=== ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ==='
              git clone https://github.com/${{ github.repository }} .
            else
              echo '=== ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ ==='
              git fetch --all
              git reset --hard origin/main
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            echo '=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ==='
            python3 -c 'import uvicorn, fastapi, flask; print(\"Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ OK\")' || echo 'Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÐÐ• Ð£Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ«'
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            echo '=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ==='
            ls -la
            ls -la backend/ || echo 'backend/ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½'
            ls -la backend/app/ || echo 'backend/app/ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½'
            
            # ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹
            echo '=== ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ ==='
            pkill -f 'uvicorn.*simple_main' || echo 'uvicorn Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½'
            pkill -f 'backend_simple.py' || echo 'backend_simple.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½'
            sleep 2
            
            # Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ FastAPI (Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· Nginx)
            echo '=== Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ FastAPI ==='
            cd backend
            nohup python3 -m uvicorn app.simple_main:app --host 127.0.0.1 --port 8080 > /tmp/fastapi.log 2>&1 &
            FASTAPI_PID=\$!
            echo \"FastAPI Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ PID: \$FASTAPI_PID Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8080\"
            sleep 3
            
            # Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Server Overpass API
            echo '=== Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Server Overpass API ==='
            cd ..
            nohup python3 backend_simple.py > /tmp/overpass.log 2>&1 &
            OVERPASS_PID=\$!
            echo \"Server Overpass API Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ PID: \$OVERPASS_PID Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 5000\"
            sleep 3
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            echo '=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² ==='
            echo 'ÐŸÑ€Ð¾Ñ†ÐµÑÑÑ‹ Python:'
            ps aux | grep python | grep -v grep || echo 'Python Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹'
            
            echo '=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ FastAPI ==='
            curl -s http://127.0.0.1:8080/health || echo 'FastAPI Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚'
            
            echo '=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Server Overpass API ==='
            curl -s http://127.0.0.1:5000/api/health || echo 'Server Overpass API Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚'
            
            echo '=== Ð›Ð¾Ð³Ð¸ FastAPI ==='
            cat /tmp/fastapi.log || echo 'FastAPI Ð»Ð¾Ð³ Ð¿ÑƒÑÑ‚'
            
            echo '=== Ð›Ð¾Ð³Ð¸ Server Overpass API ==='
            cat /tmp/overpass.log || echo 'Server Overpass API Ð»Ð¾Ð³ Ð¿ÑƒÑÑ‚'
            
            echo '=== Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx ==='
            # Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx Ð´Ð»Ñ trailspot.app
            cat > /tmp/nginx_config.conf << 'EOF'
server {
    listen 80;
    server_name trailspot.app www.trailspot.app;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    location /api/ {
        proxy_pass http://127.0.0.1:5000/api/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    location /src/ {
        proxy_pass http://127.0.0.1:8080/src/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    location /static/ {
        proxy_pass http://127.0.0.1:8080/static/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF
            sudo cp /tmp/nginx_config.conf /etc/nginx/sites-available/trailspot.app
            
            # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
            sudo ln -sf /etc/nginx/sites-available/trailspot.app /etc/nginx/sites-enabled/trailspot.app
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx
            sudo nginx -t
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Nginx
            sudo systemctl reload nginx
            
            echo '=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ‡ÐµÑ€ÐµÐ· Nginx ==='
            curl -s http://localhost/ || echo 'Nginx Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚'
            curl -s http://localhost/api/health || echo 'Nginx API Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚'
            
            echo \"Deployed FastAPI at: http://${{ secrets.VPS_HOST }}:8080/health\"
            echo \"Deployed Server Overpass API at: http://${{ secrets.VPS_HOST }}:5000/api/health\"
            echo \"TrailSpot website: http://trailspot.app\"
            echo \"TrailSpot API: http://trailspot.app/api/health\"
          "