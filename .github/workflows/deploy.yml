name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key (base64)
        run: |
          echo "${{ secrets.VPS_SSH_KEY_B64 }}" | base64 -d > key.pem
          chmod 600 key.pem

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        env:
          SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          PORT_OPT=${SSH_PORT:+-p $SSH_PORT}
          ssh -i key.pem $PORT_OPT ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            set -e
            # подготовить каталог с кодом
            mkdir -p \"$VPS_PATH\"
            if [ ! -d \"$VPS_PATH/.git\" ]; then
              cd \"$(dirname \"$VPS_PATH\")\"
              if [ -d rogein-generator ]; then rm -rf rogein-generator; fi
              git clone https://github.com/${{ github.repository }} rogein-generator
              mv rogein-generator \"$(basename \"$VPS_PATH\")\"
            fi

            cd \"$VPS_PATH\"
            git fetch --all
            git reset --hard origin/main

            # перезапускаем FastAPI на 6001
            pkill -f 'uvicorn.*6001' || true
            sleep 2
            cd backend
            nohup python3 -m uvicorn app.simple_main:app --host 0.0.0.0 --port 6001 > /tmp/fastapi.log 2>&1 &
            echo 'Deployed at: http://${{ secrets.VPS_HOST }}:6001/health'
          "