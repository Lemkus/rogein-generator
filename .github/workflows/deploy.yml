name: Deploy to REG.RU Hosting

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key (base64)
        run: |
          echo "${{ secrets.VPS_SSH_KEY_B64 }}" | base64 -d > key.pem
          chmod 600 key.pem

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        env:
          SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          PORT_OPT=${SSH_PORT:+-p $SSH_PORT}
          echo "üîç SSH –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:"
          echo "  Host: ${{ secrets.VPS_HOST }}"
          echo "  User: ${{ secrets.VPS_USER }}"
          echo "  Port: ${{ secrets.VPS_SSH_PORT }}"
          echo "  Path: ${{ secrets.VPS_PATH }}"
          echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ..."
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞..."
          ping -c 3 ${{ secrets.VPS_HOST }} || echo "Ping –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
          
          # –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã SSH —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
          for port in 22 2222 2200 22000; do
            echo "–ü—Ä–æ–±—É–µ–º –ø–æ—Ä—Ç $port..."
            echo "–ö–æ–º–∞–Ω–¥–∞: ssh -i key.pem -p $port -o ConnectTimeout=20 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}"
            
            # –ü–æ–ø—Ä–æ–±—É–µ–º 3 —Ä–∞–∑–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ä—Ç–∞
            for attempt in 1 2 3; do
              echo "–ü–æ–ø—ã—Ç–∫–∞ $attempt/3 –¥–ª—è –ø–æ—Ä—Ç–∞ $port..."
              if timeout 30 ssh -i key.pem -p $port -o ConnectTimeout=20 -o ServerAliveInterval=10 -o ServerAliveCountMax=3 -o StrictHostKeyChecking=no -o LogLevel=DEBUG3 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É $port!'" 2>&1; then
                echo "‚úÖ SSH —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É $port (–ø–æ–ø—ã—Ç–∫–∞ $attempt)"
                export WORKING_SSH_PORT=$port
                break 2  # –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±–æ–∏—Ö —Ü–∏–∫–ª–æ–≤
              else
                echo "‚ùå –ü–æ—Ä—Ç $port –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–ø—ã—Ç–∫–∞ $attempt)"
                if [ $attempt -lt 3 ]; then
                  echo "–ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π..."
                  sleep 5
                fi
              fi
            done
          done
          
          if [ -z "$WORKING_SSH_PORT" ]; then
            echo "‚ùå SSH –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∏ –Ω–∞ –æ–¥–Ω–æ–º –ø–æ—Ä—Ç—É!"
            exit 1
          fi
          echo "üîç –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ SSH –Ω–∞ –ø–æ—Ä—Ç—É $WORKING_SSH_PORT..."
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è..."
          ssh -i key.pem -p $WORKING_SSH_PORT -o ConnectTimeout=60 -o ServerAliveInterval=15 -o ServerAliveCountMax=3 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ!'"
          
          echo "üîç –ù–∞—á–∏–Ω–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –¥–µ–ø–ª–æ–π..."
          ssh -i key.pem -p $WORKING_SSH_PORT -o ConnectTimeout=60 -o ServerAliveInterval=15 -o ServerAliveCountMax=3 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            set +e  # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            echo '=== –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ REG.RU —Ö–æ—Å—Ç–∏–Ω–≥ ==='
            echo '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: \$(whoami)'
            echo 'UID: \$(id -u)'
            echo '–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: \$(pwd)'
            
            # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            mkdir -p \"$VPS_PATH\"
            cd \"$VPS_PATH\"
            echo '–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: \$(pwd)'
            
            # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            echo '=== –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ==='
            pip3 install --user uvicorn fastapi flask requests
            
            # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
            if [ ! -d \".git\" ]; then
              echo '=== –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ==='
              # –ï—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –ø—É—Å—Ç–∞—è, —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
              if [ \"\$(ls -A .)\" ]; then
                echo '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –ø—É—Å—Ç–∞—è, —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É'
                mkdir -p temp_repo
                cd temp_repo
                git clone https://github.com/${{ github.repository }} .
                # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –æ–±—Ä–∞—Ç–Ω–æ
                cp -r * ../
                cp -r .git ../
                cd ..
                rm -rf temp_repo
              else
                git clone https://github.com/${{ github.repository }} .
              fi
            else
              echo '=== –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ ==='
              git fetch --all
              git reset --hard origin/main
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo '=== –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ==='
            python3 -c 'import uvicorn, fastapi, flask; print(\"–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ OK\")' || echo '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–´'
            
            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
            echo '=== –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ ==='
            ls -la
            if [ -d \"backend/\" ]; then
              echo 'backend/ –Ω–∞–π–¥–µ–Ω'
              ls -la backend/
              if [ -d \"backend/app/\" ]; then
                echo 'backend/app/ –Ω–∞–π–¥–µ–Ω'
                ls -la backend/app/
              else
                echo 'backend/app/ –Ω–µ –Ω–∞–π–¥–µ–Ω'
              fi
            else
              echo 'backend/ –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É'
              mkdir -p backend/app
              echo '–°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ backend/app/'
            fi
            
            # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
            echo '=== –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã ==='
            echo '–ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã uvicorn...'
            ps aux | grep uvicorn | grep -v grep || echo 'uvicorn –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
            echo '–ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã backend_simple...'
            ps aux | grep backend_simple | grep -v grep || echo 'backend_simple –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
            
            echo '–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º uvicorn –ø—Ä–æ—Ü–µ—Å—Å—ã...'
            pkill -f 'uvicorn.*simple_main' 2>/dev/null || echo 'uvicorn –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏'
            echo '–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º backend_simple –ø—Ä–æ—Ü–µ—Å—Å—ã...'
            pkill -f 'backend_simple.py' 2>/dev/null || echo 'backend_simple –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏'
            
            echo '–ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...'
            sleep 3
            
            echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã...'
            ps aux | grep -E '(uvicorn|backend_simple)' | grep -v grep || echo '–í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã'
            
            # –ó–∞–ø—É—Å—Ç–∏—Ç—å FastAPI (–±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ Nginx)
            echo '=== –ó–∞–ø—É—Å–∫–∞–µ–º FastAPI ==='
            echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 8080...'
            netstat -tlnp | grep :8080 || echo '–ü–æ—Ä—Ç 8080 —Å–≤–æ–±–æ–¥–µ–Ω'
            echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 5000...'
            netstat -tlnp | grep :5000 || echo '–ü–æ—Ä—Ç 5000 —Å–≤–æ–±–æ–¥–µ–Ω'
            
            cd backend
            echo '–ó–∞–ø—É—Å–∫–∞–µ–º FastAPI –Ω–∞ –ø–æ—Ä—Ç—É 8080...'
            nohup python3 -m uvicorn app.simple_main:app --host 127.0.0.1 --port 8080 > /tmp/fastapi.log 2>&1 &
            FASTAPI_PID=\$!
            echo \"FastAPI –∑–∞–ø—É—â–µ–Ω —Å PID: \$FASTAPI_PID –Ω–∞ –ø–æ—Ä—Ç—É 8080\"
            sleep 3
            
            # –ó–∞–ø—É—Å—Ç–∏—Ç—å Server Overpass API
            echo '=== –ó–∞–ø—É—Å–∫–∞–µ–º Server Overpass API ==='
            cd ..
            echo '–ó–∞–ø—É—Å–∫–∞–µ–º Server Overpass API –Ω–∞ –ø–æ—Ä—Ç—É 5000...'
            nohup python3 backend_simple.py > /tmp/overpass.log 2>&1 &
            OVERPASS_PID=\$!
            echo \"Server Overpass API –∑–∞–ø—É—â–µ–Ω —Å PID: \$OVERPASS_PID –Ω–∞ –ø–æ—Ä—Ç—É 5000\"
            sleep 3
            
            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–∏—Å–æ–≤
            echo '=== –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–∏—Å–æ–≤ ==='
            echo '–ü—Ä–æ—Ü–µ—Å—Å—ã Python:'
            ps aux | grep python | grep -v grep || echo 'Python –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
            
            echo '=== –ü—Ä–æ–≤–µ—Ä—è–µ–º FastAPI ==='
            curl -s http://127.0.0.1:8080/health || echo 'FastAPI –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç'
            
            echo '=== –ü—Ä–æ–≤–µ—Ä—è–µ–º Server Overpass API ==='
            curl -s http://127.0.0.1:5000/api/health || echo 'Server Overpass API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç'
            
            echo '=== –õ–æ–≥–∏ FastAPI ==='
            cat /tmp/fastapi.log || echo 'FastAPI –ª–æ–≥ –ø—É—Å—Ç'
            
            echo '=== –õ–æ–≥–∏ Server Overpass API ==='
            cat /tmp/overpass.log || echo 'Server Overpass API –ª–æ–≥ –ø—É—Å—Ç'
            
            echo \"Deployed FastAPI at: http://${{ secrets.VPS_HOST }}:8080/health\"
            echo \"Deployed Server Overpass API at: http://${{ secrets.VPS_HOST }}:5000/api/health\"
            echo \"TrailSpot website: http://trailspot.app\"
            echo \"TrailSpot API: http://trailspot.app/api/health\"
          "