<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D –°–∏–º—É–ª—è—Ç–æ—Ä –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ - –í–∏–¥ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
            color: white;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 50%, #8FBC8F 100%);
        }
        
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .ui-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }
        
        .top-panel {
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bottom-panel {
            bottom: 20px;
            left: 20px;
            right: 20px;
            text-align: center;
        }
        
        .left-panel {
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
        }
        
        .right-panel {
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
        }
        
        .stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #45b7aa;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .audio-toggle {
            background: #ff6b6b;
        }
        
        .audio-toggle.active {
            background: #4ecdc4;
        }
        
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .crosshair::before {
            top: 50%;
            left: 2px;
            right: 2px;
            height: 2px;
            transform: translateY(-50%);
        }
        
        .crosshair::after {
            left: 50%;
            top: 2px;
            bottom: 2px;
            width: 2px;
            transform: translateX(-50%);
        }
        
        .direction-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 2px solid rgba(78, 205, 196, 0.5);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .direction-indicator.active {
            opacity: 1;
            animation: pulse 1s infinite;
        }
        
        .direction-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #4ecdc4;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .navigation-status {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .navigation-status.navigating {
            background: rgba(78, 205, 196, 0.3);
        }
        
        .navigation-status.reached {
            background: rgba(45, 183, 170, 0.3);
        }
        
        .minimap {
            width: 200px;
            height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .minimap-player {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ff6b6b;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
        }
        
        .minimap-target {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #4ecdc4;
            border-radius: 50%;
            border: 1px solid white;
            transform: translate(-50%, -50%);
        }
        
        .minimap-trail {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-overlay">
            <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
            <div class="ui-panel top-panel">
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="currentDistance">--</div>
                        <div class="stat-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="currentSpeed">5</div>
                        <div class="stat-label">–°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="pointsReached">0</div>
                        <div class="stat-label">–¢–æ—á–µ–∫ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="gameTime">00:00</div>
                        <div class="stat-label">–í—Ä–µ–º—è –∏–≥—Ä—ã</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="audioToggle" class="audio-toggle">üîá –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
                    <button id="startGame" disabled>üéØ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                    <button id="pauseGame" disabled>‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                    <button id="resetGame">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                </div>
            </div>
            
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ -->
            <div class="ui-panel left-panel">
                <div class="minimap" id="minimap">
                    <div class="minimap-player" id="minimapPlayer"></div>
                    <div class="minimap-target" id="minimapTarget"></div>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
            <div class="ui-panel right-panel">
                <div class="instructions">
                    <h4>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h4>
                    <ul>
                        <li><strong>W</strong> - –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥ –ø–æ —Ç—Ä–æ–ø–µ</li>
                        <li><strong>S</strong> - –î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞–∑–∞–¥ –ø–æ —Ç—Ä–æ–ø–µ</li>
                        <li><strong>A</strong> - –î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ –ø–æ —Ç—Ä–æ–ø–µ</li>
                        <li><strong>D</strong> - –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ –ø–æ —Ç—Ä–æ–ø–µ</li>
                        <li><strong>–ú—ã—à—å</strong> - –ü–æ–≤–æ—Ä–æ—Ç –∫–∞–º–µ—Ä—ã</li>
                        <li><strong>–ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É</strong> - –í—ã–±–æ—Ä —Ç—Ä–æ–ø—ã</li>
                        <li><strong>ESC</strong> - –ü–∞—É–∑–∞</li>
                    </ul>
                    
                    <h4>üîä –ó–≤—É–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:</h4>
                    <ul>
                        <li><strong>–í—ã—Å–æ–∫–∏–π —Ç–æ–Ω:</strong> –ë–ª–∏–∑–∫–æ –∫ —Ü–µ–ª–∏</li>
                        <li><strong>–ù–∏–∑–∫–∏–π —Ç–æ–Ω:</strong> –î–∞–ª–µ–∫–æ –æ—Ç —Ü–µ–ª–∏</li>
                        <li><strong>–í–æ—Å—Ö–æ–¥—è—â–∏–π:</strong> –ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç–µ—Å—å</li>
                        <li><strong>–ù–∏—Å—Ö–æ–¥—è—â–∏–π:</strong> –£–¥–∞–ª—è–µ—Ç–µ—Å—å</li>
                    </ul>
                </div>
                
                <div class="navigation-status" id="navStatus">–ì–æ—Ç–æ–≤ –∫ —Å—Ç–∞—Ä—Ç—É</div>
            </div>
            
            <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
            <div class="ui-panel bottom-panel">
                <div id="directionChoices">
                    <!-- –í—ã–±–æ—Ä—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <!-- –ü—Ä–∏—Ü–µ–ª -->
            <div class="crosshair"></div>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="direction-indicator" id="directionIndicator"></div>
        </div>
    </div>

    <script type="module">
        import { playSoundPattern, playDirectionSound, toggleAudio, isAudioOn } from './src/modules/audioModuleImproved.js';
        
        // 3D –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let gameState = {
            isRunning: false,
            isPaused: false,
            currentTarget: null,
            playerPosition: { x: 0, y: 0, z: 0 },
            playerRotation: { x: 0, y: 0 },
            trails: [],
            targetPoints: [],
            pointsReached: 0,
            startTime: null,
            gameTime: 0,
            lastDistance: null,
            navigationActive: false,
            availableDirections: []
        };
        
        // Canvas –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const audioToggle = document.getElementById('audioToggle');
        const navStatus = document.getElementById('navStatus');
        const startGame = document.getElementById('startGame');
        const pauseGame = document.getElementById('pauseGame');
        const resetGame = document.getElementById('resetGame');
        const directionChoices = document.getElementById('directionChoices');
        const directionIndicator = document.getElementById('directionIndicator');
        const minimap = document.getElementById('minimap');
        const minimapPlayer = document.getElementById('minimapPlayer');
        const minimapTarget = document.getElementById('minimapTarget');
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const currentDistance = document.getElementById('currentDistance');
        const currentSpeed = document.getElementById('currentSpeed');
        const pointsReached = document.getElementById('pointsReached');
        const gameTime = document.getElementById('gameTime');
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const keys = {};
        let mouseX = 0, mouseY = 0;
        let isMouseLocked = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è canvas
        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º—ã—à–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–æ–π
            canvas.addEventListener('click', () => {
                if (!isMouseLocked) {
                    canvas.requestPointerLock();
                }
            });
            
            document.addEventListener('pointerlockchange', () => {
                isMouseLocked = document.pointerLockElement === canvas;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isMouseLocked) {
                    mouseX += e.movementX * 0.002;
                    mouseY += e.movementY * 0.002;
                    mouseY = Math.max(-Math.PI/2, Math.min(Math.PI/2, mouseY));
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            document.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                if (e.code === 'Escape') {
                    if (gameState.isRunning) {
                        togglePause();
                    }
                }
                if (e.code === 'Space') {
                    e.preventDefault();
                    selectDirection();
                }
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            createTrails();
            createTargetPoints();
            updateMinimap();
            updateStats();
            
            startGame.disabled = false;
            console.log('üéÆ 3D –ò–≥—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–æ–ø
        function createTrails() {
            gameState.trails = [
                // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ (0,0) - –Ω–∞—á–∞–ª–æ
                { id: 1, start: { x: 0, z: 0 }, end: { x: 30, z: 0 }, direction: 'east' },
                { id: 2, start: { x: 0, z: 0 }, end: { x: 0, z: 30 }, direction: 'north' },
                { id: 3, start: { x: 0, z: 0 }, end: { x: -30, z: 0 }, direction: 'west' },
                { id: 4, start: { x: 0, z: 0 }, end: { x: 0, z: -30 }, direction: 'south' },
                { id: 5, start: { x: 0, z: 0 }, end: { x: 21, z: 21 }, direction: 'northeast' },
                { id: 6, start: { x: 0, z: 0 }, end: { x: -21, z: 21 }, direction: 'northwest' },
                { id: 7, start: { x: 0, z: 0 }, end: { x: 21, z: -21 }, direction: 'southeast' },
                { id: 8, start: { x: 0, z: 0 }, end: { x: -21, z: -21 }, direction: 'southwest' },
                
                // –û—Ç —Ç–æ—á–∫–∏ (30,0) - –≤–æ—Å—Ç–æ–∫
                { id: 9, start: { x: 30, z: 0 }, end: { x: 60, z: 0 }, direction: 'east' },
                { id: 10, start: { x: 30, z: 0 }, end: { x: 30, z: 30 }, direction: 'north' },
                { id: 11, start: { x: 30, z: 0 }, end: { x: 30, z: -30 }, direction: 'south' },
                { id: 12, start: { x: 30, z: 0 }, end: { x: 51, z: 21 }, direction: 'northeast' },
                { id: 13, start: { x: 30, z: 0 }, end: { x: 51, z: -21 }, direction: 'southeast' },
                
                // –û—Ç —Ç–æ—á–∫–∏ (0,30) - —Å–µ–≤–µ—Ä
                { id: 14, start: { x: 0, z: 30 }, end: { x: 0, z: 60 }, direction: 'north' },
                { id: 15, start: { x: 0, z: 30 }, end: { x: 30, z: 30 }, direction: 'east' },
                { id: 16, start: { x: 0, z: 30 }, end: { x: -30, z: 30 }, direction: 'west' },
                { id: 17, start: { x: 0, z: 30 }, end: { x: 21, z: 51 }, direction: 'northeast' },
                { id: 18, start: { x: 0, z: 30 }, end: { x: -21, z: 51 }, direction: 'northwest' },
                
                // –û—Ç —Ç–æ—á–∫–∏ (-30,0) - –∑–∞–ø–∞–¥
                { id: 19, start: { x: -30, z: 0 }, end: { x: -60, z: 0 }, direction: 'west' },
                { id: 20, start: { x: -30, z: 0 }, end: { x: -30, z: 30 }, direction: 'north' },
                { id: 21, start: { x: -30, z: 0 }, end: { x: -30, z: -30 }, direction: 'south' },
                { id: 22, start: { x: -30, z: 0 }, end: { x: -51, z: 21 }, direction: 'northwest' },
                { id: 23, start: { x: -30, z: 0 }, end: { x: -51, z: -21 }, direction: 'southwest' },
                
                // –û—Ç —Ç–æ—á–∫–∏ (0,-30) - —é–≥
                { id: 24, start: { x: 0, z: -30 }, end: { x: 0, z: -60 }, direction: 'south' },
                { id: 25, start: { x: 0, z: -30 }, end: { x: 30, z: -30 }, direction: 'east' },
                { id: 26, start: { x: 0, z: -30 }, end: { x: -30, z: -30 }, direction: 'west' },
                { id: 27, start: { x: 0, z: -30 }, end: { x: 21, z: -51 }, direction: 'southeast' },
                { id: 28, start: { x: 0, z: -30 }, end: { x: -21, z: -51 }, direction: 'southwest' },
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                { id: 29, start: { x: 21, z: 21 }, end: { x: 51, z: 51 }, direction: 'northeast' },
                { id: 30, start: { x: -21, z: 21 }, end: { x: -51, z: 51 }, direction: 'northwest' },
                { id: 31, start: { x: 21, z: -21 }, end: { x: 51, z: -51 }, direction: 'southeast' },
                { id: 32, start: { x: -21, z: -21 }, end: { x: -51, z: -51 }, direction: 'southwest' }
            ];
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ª–µ–≤—ã—Ö —Ç–æ—á–µ–∫
        function createTargetPoints() {
            gameState.targetPoints = [
                { id: 1, x: 60, z: 0, reached: false },
                { id: 2, x: 0, z: 60, reached: false },
                { id: 3, x: -60, z: 0, reached: false },
                { id: 4, x: 0, z: -60, reached: false },
                { id: 5, x: 51, z: 51, reached: false },
                { id: 6, x: -51, z: 51, reached: false },
                { id: 7, x: 51, z: -51, reached: false },
                { id: 8, x: -51, z: -51, reached: false }
            ];
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ü–µ–ª–µ–≤—É—é —Ç–æ—á–∫—É
            gameState.currentTarget = gameState.targetPoints[Math.floor(Math.random() * gameState.targetPoints.length)];
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ 3D —Å—Ü–µ–Ω—ã
        function render3D() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º –Ω–µ–±–æ —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–æ–º
            const horizonY = canvas.height * 0.6; // –õ–∏–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
            
            // –ù–µ–±–æ
            const skyGradient = ctx.createLinearGradient(0, 0, 0, horizonY);
            skyGradient.addColorStop(0, '#87CEEB');
            skyGradient.addColorStop(1, '#B0E0E6');
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, horizonY);
            
            // –ó–µ–º–ª—è
            const groundGradient = ctx.createLinearGradient(0, horizonY, 0, canvas.height);
            groundGradient.addColorStop(0, '#98FB98');
            groundGradient.addColorStop(1, '#8FBC8F');
            ctx.fillStyle = groundGradient;
            ctx.fillRect(0, horizonY, canvas.width, canvas.height - horizonY);
            
            // –õ–∏–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, horizonY);
            ctx.lineTo(canvas.width, horizonY);
            ctx.stroke();
            
            // –†–∏—Å—É–µ–º —Ç—Ä–æ–ø—ã
            renderTrails();
            
            // –†–∏—Å—É–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            renderObstacles();
            
            // –†–∏—Å—É–µ–º —Ü–µ–ª–µ–≤—ã–µ —Ç–æ—á–∫–∏
            renderTargetPoints();
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç—Ä–æ–ø
        function renderTrails() {
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—Ä–æ–ø—ã –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            const sortedTrails = gameState.trails.map(trail => {
                const start = worldToScreen(trail.start.x, trail.start.z);
                const end = worldToScreen(trail.end.x, trail.end.z);
                return { trail, start, end };
            }).filter(item => item.start && item.end)
              .sort((a, b) => b.start.distance - a.start.distance); // –î–∞–ª—å–Ω–∏–µ —Ç—Ä–æ–ø—ã —Ä–∏—Å—É–µ–º –ø–µ—Ä–≤—ã–º–∏
            
            // –†–∏—Å—É–µ–º –≤—Å–µ —Ç—Ä–æ–ø—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π 3D –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–æ–π
            sortedTrails.forEach(({ trail, start, end }) => {
                // –®–∏—Ä–∏–Ω–∞ —Ç—Ä–æ–ø—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (—á–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º —É–∂–µ)
                const trailWidth = Math.max(2, 15 - start.distance * 0.1);
                
                // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª —Ç—Ä–æ–ø—ã
                const angle = Math.atan2(end.y - start.y, end.x - start.x);
                const length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                
                // –†–∏—Å—É–µ–º —Ç—Ä–æ–ø—É –∫–∞–∫ –¥–æ—Ä–æ–∂–∫—É
                ctx.save();
                ctx.translate(start.x, start.y);
                ctx.rotate(angle);
                
                // –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ—Ä–æ–∂–∫–∞
                ctx.fillStyle = `rgba(139, 69, 19, ${Math.max(0.3, 1 - start.distance * 0.01)})`;
                ctx.fillRect(-trailWidth/2, 0, trailWidth, length);
                
                // –õ–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.max(0.3, 0.8 - start.distance * 0.01)})`;
                ctx.fillRect(-trailWidth/2 - 1, 0, 2, length);
                
                // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.max(0.3, 0.8 - start.distance * 0.01)})`;
                ctx.fillRect(trailWidth/2 - 1, 0, 2, length);
                
                // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è (–ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è)
                ctx.strokeStyle = `rgba(255, 255, 255, ${Math.max(0.2, 0.6 - start.distance * 0.01)})`;
                ctx.lineWidth = Math.max(1, 2 - start.distance * 0.05);
                ctx.setLineDash([Math.max(3, 8 - start.distance * 0.1), Math.max(3, 8 - start.distance * 0.1)]);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(0, length);
                ctx.stroke();
                
                ctx.restore();
            });
            
            // –†–∏—Å—É–µ–º —Ç—Ä–æ–ø—ã –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–∫–æ–º –∫–∞–∫ –¥–æ—Ä–æ–∂–∫–∏ (—Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏)
            const currentPos = gameState.playerPosition;
            const currentTrails = gameState.trails.filter(trail => 
                Math.abs(trail.start.x - currentPos.x) < 2 && 
                Math.abs(trail.start.z - currentPos.z) < 2
            );
            
            currentTrails.forEach(trail => {
                // –†–∏—Å—É–µ–º —Ç—Ä–æ–ø—É –∫–∞–∫ –¥–æ—Ä–æ–∂–∫—É –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–∫–æ–º
                const trailLength = 200; // –î–ª–∏–Ω–∞ –≤–∏–¥–∏–º–æ–π —á–∞—Å—Ç–∏ —Ç—Ä–æ–ø—ã
                const trailWidth = 25; // –®–∏—Ä–∏–Ω–∞ —Ç—Ä–æ–ø—ã
                
                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–æ–ø—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–≥—Ä–æ–∫–∞
                const dx = trail.end.x - trail.start.x;
                const dz = trail.end.z - trail.start.z;
                const trailAngle = Math.atan2(dz, dx);
                
                // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞–º–µ—Ä—ã
                const relativeAngle = trailAngle - gameState.playerRotation.y;
                
                // –†–∏—Å—É–µ–º —Ç—Ä–æ–ø—É –∫–∞–∫ –¥–æ—Ä–æ–∂–∫—É –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–∫–æ–º
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(relativeAngle);
                
                // –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ—Ä–æ–∂–∫–∞
                ctx.fillStyle = 'rgba(139, 69, 19, 0.9)';
                ctx.fillRect(-trailWidth/2, -5, trailWidth, trailLength);
                
                // –õ–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fillRect(-trailWidth/2 - 2, -5, 3, trailLength);
                
                // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fillRect(trailWidth/2 - 1, -5, 3, trailLength);
                
                // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.lineWidth = 2;
                ctx.setLineDash([8, 8]);
                ctx.beginPath();
                ctx.moveTo(0, -5);
                ctx.lineTo(0, trailLength);
                ctx.stroke();
                
                // –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                ctx.fillStyle = '#4ecdc4';
                ctx.beginPath();
                ctx.moveTo(0, -15);
                ctx.lineTo(-6, -2);
                ctx.lineTo(6, -2);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
            });
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ü–µ–ª–µ–≤—ã—Ö —Ç–æ—á–µ–∫
        function renderTargetPoints() {
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            const sortedPoints = gameState.targetPoints.map(point => {
                const screenPos = worldToScreen(point.x, point.z);
                return { point, screenPos };
            }).filter(item => item.screenPos)
              .sort((a, b) => b.screenPos.distance - a.screenPos.distance);
            
            sortedPoints.forEach(({ point, screenPos }) => {
                const isCurrent = point.id === gameState.currentTarget.id;
                const size = Math.max(3, (isCurrent ? 15 : 10) - screenPos.distance * 0.1);
                const color = point.reached ? '#45b7aa' : (isCurrent ? '#ff6b6b' : '#4ecdc4');
                const alpha = Math.max(0.3, 1 - screenPos.distance * 0.01);
                
                ctx.fillStyle = color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
                ctx.beginPath();
                ctx.arc(screenPos.x, screenPos.y, size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.lineWidth = Math.max(1, 2 - screenPos.distance * 0.05);
                ctx.stroke();
                
                if (isCurrent) {
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏
                    const pulse = Math.sin(Date.now() * 0.005) * 0.3 + 1;
                    ctx.beginPath();
                    ctx.arc(screenPos.x, screenPos.y, size * pulse, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(255, 107, 107, ${alpha * 0.5})`;
                    ctx.lineWidth = Math.max(1, 3 - screenPos.distance * 0.05);
                    ctx.stroke();
                }
            });
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
        function renderObstacles() {
            const obstacles = [
                { x: 15, z: 15, size: 6 },
                { x: -15, z: 15, size: 5 },
                { x: 15, z: -15, size: 7 },
                { x: -15, z: -15, size: 4 },
                { x: 45, z: 15, size: 8 },
                { x: -45, z: 15, size: 6 },
                { x: 15, z: 45, size: 5 },
                { x: -15, z: 45, size: 7 }
            ];
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            const sortedObstacles = obstacles.map(obstacle => {
                const screenPos = worldToScreen(obstacle.x, obstacle.z);
                return { obstacle, screenPos };
            }).filter(item => item.screenPos)
              .sort((a, b) => b.screenPos.distance - a.screenPos.distance);
            
            sortedObstacles.forEach(({ obstacle, screenPos }) => {
                const size = Math.max(2, obstacle.size - screenPos.distance * 0.1);
                const alpha = Math.max(0.3, 0.8 - screenPos.distance * 0.01);
                
                ctx.fillStyle = `rgba(139, 69, 19, ${alpha})`;
                ctx.beginPath();
                ctx.arc(screenPos.x, screenPos.y, size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = `rgba(101, 67, 33, ${alpha})`;
                ctx.lineWidth = Math.max(1, 2 - screenPos.distance * 0.05);
                ctx.stroke();
            });
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–∏—Ä–æ–≤—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ —Å –Ω–∞—Å—Ç–æ—è—â–µ–π 3D –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–æ–π
        function worldToScreen(worldX, worldZ) {
            const dx = worldX - gameState.playerPosition.x;
            const dz = worldZ - gameState.playerPosition.z;
            
            // –ü–æ–≤–æ—Ä–æ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞–º–µ—Ä—ã
            const cos = Math.cos(gameState.playerRotation.y);
            const sin = Math.sin(gameState.playerRotation.y);
            
            const rotatedX = dx * cos - dz * sin;
            const rotatedZ = dx * sin + dz * cos;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –æ–±—ä–µ–∫—Ç –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π
            if (rotatedZ <= 0.1) return null;
            
            // –ù–∞—Å—Ç–æ—è—â–∞—è 3D –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞
            const fov = 60; // –ü–æ–ª–µ –∑—Ä–µ–Ω–∏—è –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
            const fovRad = fov * Math.PI / 180;
            const scale = canvas.height / (2 * Math.tan(fovRad / 2));
            
            const screenX = canvas.width / 2 + (rotatedX * scale) / rotatedZ;
            const screenY = canvas.height / 2 - (rotatedZ * scale) / rotatedZ;
            
            return { x: screenX, y: screenY, distance: rotatedZ };
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function updateGameState() {
            if (!gameState.isRunning || gameState.isPaused) return;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è WASD
            const moveSpeed = 0.5;
            let newX = gameState.playerPosition.x;
            let newZ = gameState.playerPosition.z;
            
            // –ù–∞—Ö–æ–¥–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–æ–ø—ã –æ—Ç —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
            const availableTrails = gameState.trails.filter(trail => 
                Math.abs(trail.start.x - gameState.playerPosition.x) < 3 && 
                Math.abs(trail.start.z - gameState.playerPosition.z) < 3
            );
            
            if (availableTrails.length > 0) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –∫–ª–∞–≤–∏—à–∞–º
                let moveDirection = null;
                
                if (keys['KeyW']) {
                    // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥ - –Ω–∞—Ö–æ–¥–∏–º —Ç—Ä–æ–ø—É, –∫–æ—Ç–æ—Ä–∞—è –∏–¥–µ—Ç –≤–ø–µ—Ä–µ–¥
                    const forwardTrail = availableTrails.find(trail => {
                        const dx = trail.end.x - trail.start.x;
                        const dz = trail.end.z - trail.start.z;
                        const angle = Math.atan2(dz, dx);
                        const playerAngle = gameState.playerRotation.y;
                        const angleDiff = Math.abs(angle - playerAngle);
                        return angleDiff < Math.PI / 4 || angleDiff > 7 * Math.PI / 4;
                    });
                    if (forwardTrail) moveDirection = forwardTrail;
                }
                
                if (keys['KeyS']) {
                    // –î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞–∑–∞–¥ - –Ω–∞—Ö–æ–¥–∏–º —Ç—Ä–æ–ø—É, –∫–æ—Ç–æ—Ä–∞—è –∏–¥–µ—Ç –Ω–∞–∑–∞–¥
                    const backwardTrail = availableTrails.find(trail => {
                        const dx = trail.end.x - trail.start.x;
                        const dz = trail.end.z - trail.start.z;
                        const angle = Math.atan2(dz, dx);
                        const playerAngle = gameState.playerRotation.y;
                        const angleDiff = Math.abs(angle - playerAngle);
                        return angleDiff > 3 * Math.PI / 4 && angleDiff < 5 * Math.PI / 4;
                    });
                    if (backwardTrail) moveDirection = backwardTrail;
                }
                
                if (keys['KeyA']) {
                    // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ
                    const leftTrail = availableTrails.find(trail => {
                        const dx = trail.end.x - trail.start.x;
                        const dz = trail.end.z - trail.start.z;
                        const angle = Math.atan2(dz, dx);
                        const playerAngle = gameState.playerRotation.y;
                        const angleDiff = angle - playerAngle;
                        return angleDiff > Math.PI / 2 && angleDiff < 3 * Math.PI / 2;
                    });
                    if (leftTrail) moveDirection = leftTrail;
                }
                
                if (keys['KeyD']) {
                    // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ
                    const rightTrail = availableTrails.find(trail => {
                        const dx = trail.end.x - trail.start.x;
                        const dz = trail.end.z - trail.start.z;
                        const angle = Math.atan2(dz, dx);
                        const playerAngle = gameState.playerRotation.y;
                        const angleDiff = angle - playerAngle;
                        return angleDiff < -Math.PI / 2 || angleDiff > Math.PI / 2;
                    });
                    if (rightTrail) moveDirection = rightTrail;
                }
                
                // –î–≤–∏–≥–∞–µ–º –∏–≥—Ä–æ–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç—Ä–æ–ø–µ
                if (moveDirection) {
                    const dx = moveDirection.end.x - moveDirection.start.x;
                    const dz = moveDirection.end.z - moveDirection.start.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);
                    
                    if (distance > 0) {
                        const stepX = (dx / distance) * moveSpeed;
                        const stepZ = (dz / distance) * moveSpeed;
                        
                        newX = gameState.playerPosition.x + stepX;
                        newZ = gameState.playerPosition.z + stepZ;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—à–ª–∏ –ª–∏ –º—ã –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ç—Ä–æ–ø—ã
                        const trailProgress = Math.sqrt(
                            Math.pow(newX - moveDirection.start.x, 2) + 
                            Math.pow(newZ - moveDirection.start.z, 2)
                        );
                        
                        if (trailProgress >= distance) {
                            // –î–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞ —Ç—Ä–æ–ø—ã
                            newX = moveDirection.end.x;
                            newZ = moveDirection.end.z;
                            updateAvailableDirections();
                        }
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞
            gameState.playerPosition.x = newX;
            gameState.playerPosition.z = newZ;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            updateNavigation();
            updateMinimap();
            checkTargetReached();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
        function updateAvailableDirections() {
            const currentPos = gameState.playerPosition;
            gameState.availableDirections = gameState.trails.filter(trail => 
                Math.abs(trail.start.x - currentPos.x) < 3 && 
                Math.abs(trail.start.z - currentPos.z) < 3
            );
            
            updateDirectionChoices();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
        function updateDirectionChoices() {
            if (gameState.availableDirections.length === 0) {
                directionChoices.innerHTML = '<div style="color: #666;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–æ–ø</div>';
                return;
            }
            
            const choicesHtml = gameState.availableDirections.map(trail => {
                const directionNames = {
                    'north': '‚¨ÜÔ∏è –°–µ–≤–µ—Ä',
                    'south': '‚¨áÔ∏è –Æ–≥',
                    'east': '‚û°Ô∏è –í–æ—Å—Ç–æ–∫',
                    'west': '‚¨ÖÔ∏è –ó–∞–ø–∞–¥',
                    'northeast': '‚ÜóÔ∏è –°–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫',
                    'northwest': '‚ÜñÔ∏è –°–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥',
                    'southeast': '‚ÜòÔ∏è –Æ–≥–æ-–≤–æ—Å—Ç–æ–∫',
                    'southwest': '‚ÜôÔ∏è –Æ–≥–æ-–∑–∞–ø–∞–¥'
                };
                
                return `
                    <button onclick="selectDirection(${trail.id})" style="margin: 5px;">
                        ${directionNames[trail.direction]}
                    </button>
                `;
            }).join('');
            
            directionChoices.innerHTML = choicesHtml;
        }
        
        // –í—ã–±–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        window.selectDirection = function(trailId) {
            if (!gameState.isRunning || gameState.isPaused) return;
            
            const trail = gameState.trails.find(t => t.id === trailId);
            if (!trail) return;
            
            // –î–≤–∏–≥–∞–µ–º –∏–≥—Ä–æ–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç—Ä–æ–ø–µ
            movePlayer(trail);
        };
        
        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        function movePlayer(trail) {
            const steps = 30;
            const stepX = (trail.end.x - trail.start.x) / steps;
            const stepZ = (trail.end.z - trail.start.z) / steps;
            
            let currentStep = 0;
            
            const moveInterval = setInterval(() => {
                if (!gameState.isRunning || gameState.isPaused) {
                    clearInterval(moveInterval);
                    return;
                }
                
                currentStep++;
                gameState.playerPosition.x = trail.start.x + (stepX * currentStep);
                gameState.playerPosition.z = trail.start.z + (stepZ * currentStep);
                
                updateNavigation();
                updateMinimap();
                
                if (currentStep >= steps) {
                    clearInterval(moveInterval);
                    gameState.playerPosition.x = trail.end.x;
                    gameState.playerPosition.z = trail.end.z;
                    updateAvailableDirections();
                    checkTargetReached();
                }
            }, 100);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function updateNavigation() {
            if (!gameState.currentTarget) return;
            
            const distance = Math.sqrt(
                Math.pow(gameState.currentTarget.x - gameState.playerPosition.x, 2) + 
                Math.pow(gameState.currentTarget.z - gameState.playerPosition.z, 2)
            );
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            currentDistance.textContent = Math.round(distance) + '–º';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
            let direction = 'neutral';
            if (gameState.lastDistance !== null) {
                if (distance < gameState.lastDistance - 2) {
                    direction = 'approaching';
                } else if (distance > gameState.lastDistance + 2) {
                    direction = 'moving_away';
                }
            }
            
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            if (isAudioOn() && gameState.isRunning) {
                let pattern;
                if (distance < 20) {
                    pattern = [100]; // –û—á–µ–Ω—å –±–ª–∏–∑–∫–æ
                } else if (distance < 40) {
                    pattern = [150]; // –ì–æ—Ä—è—á–æ
                } else if (distance < 70) {
                    pattern = [200]; // –¢–µ–ø–ª–æ
                } else if (distance < 100) {
                    pattern = [250]; // –ü—Ä–æ—Ö–ª–∞–¥–Ω–æ
                } else {
                    pattern = [300]; // –•–æ–ª–æ–¥–Ω–æ
                }
                
                playSoundPattern(pattern, direction, distance);
                
                if (direction !== 'neutral') {
                    setTimeout(() => playDirectionSound(direction), 200);
                }
            }
            
            gameState.lastDistance = distance;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            if (distance < 20) {
                navStatus.textContent = 'üéØ –û—á–µ–Ω—å –±–ª–∏–∑–∫–æ!';
                navStatus.className = 'navigation-status navigating';
                directionIndicator.classList.add('active');
            } else if (distance < 100) {
                navStatus.textContent = `üìç ${Math.round(distance)}–º –¥–æ —Ü–µ–ª–∏`;
                navStatus.className = 'navigation-status navigating';
                directionIndicator.classList.remove('active');
            } else {
                navStatus.textContent = `üìç ${Math.round(distance)}–º –¥–æ —Ü–µ–ª–∏`;
                navStatus.className = 'navigation-status';
                directionIndicator.classList.remove('active');
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏
        function checkTargetReached() {
            if (!gameState.currentTarget) return;
            
            const distance = Math.sqrt(
                Math.pow(gameState.currentTarget.x - gameState.playerPosition.x, 2) + 
                Math.pow(gameState.currentTarget.z - gameState.playerPosition.z, 2)
            );
            
            if (distance < 15) {
                // –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!
                gameState.currentTarget.reached = true;
                gameState.pointsReached++;
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏
                if (isAudioOn()) {
                    playSoundPattern([200, 100, 200, 100, 200], 'neutral', 0);
                }
                
                navStatus.textContent = 'üéâ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!';
                navStatus.className = 'navigation-status reached';
                
                // –í—ã–±–∏—Ä–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é —Ü–µ–ª—å
                setTimeout(() => {
                    const unreachedPoints = gameState.targetPoints.filter(p => !p.reached);
                    if (unreachedPoints.length > 0) {
                        gameState.currentTarget = unreachedPoints[Math.floor(Math.random() * unreachedPoints.length)];
                        gameState.lastDistance = null;
                        navStatus.textContent = 'üéØ –ù–æ–≤–∞—è —Ü–µ–ª—å –≤—ã–±—Ä–∞–Ω–∞!';
                        navStatus.className = 'navigation-status navigating';
                    } else {
                        // –í—Å–µ —Ü–µ–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã!
                        endGame();
                    }
                }, 2000);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–∫–∞—Ä—Ç—ã
        function updateMinimap() {
            const scale = 1.5;
            const centerX = minimap.clientWidth / 2;
            const centerY = minimap.clientHeight / 2;
            
            // –û—á–∏—â–∞–µ–º –º–∏–Ω–∏–∫–∞—Ä—Ç—É
            minimap.innerHTML = '';
            
            // –†–∏—Å—É–µ–º —Ç—Ä–æ–ø—ã –Ω–∞ –º–∏–Ω–∏–∫–∞—Ä—Ç–µ
            const minimapCanvas = document.createElement('canvas');
            minimapCanvas.width = minimap.clientWidth;
            minimapCanvas.height = minimap.clientHeight;
            minimapCanvas.style.position = 'absolute';
            minimapCanvas.style.top = '0';
            minimapCanvas.style.left = '0';
            minimapCanvas.style.zIndex = '1';
            minimap.appendChild(minimapCanvas);
            
            const minimapCtx = minimapCanvas.getContext('2d');
            
            // –†–∏—Å—É–µ–º —Ç—Ä–æ–ø—ã
            minimapCtx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            minimapCtx.lineWidth = 2;
            minimapCtx.lineCap = 'round';
            
            gameState.trails.forEach(trail => {
                const startX = centerX + trail.start.x * scale;
                const startY = centerY - trail.start.z * scale;
                const endX = centerX + trail.end.x * scale;
                const endY = centerY - trail.end.z * scale;
                
                minimapCtx.beginPath();
                minimapCtx.moveTo(startX, startY);
                minimapCtx.lineTo(endX, endY);
                minimapCtx.stroke();
            });
            
            // –†–∏—Å—É–µ–º —Ü–µ–ª–µ–≤—ã–µ —Ç–æ—á–∫–∏
            gameState.targetPoints.forEach(point => {
                const pointX = centerX + point.x * scale;
                const pointY = centerY - point.z * scale;
                
                const pointElement = document.createElement('div');
                pointElement.className = 'minimap-target';
                pointElement.style.left = pointX + 'px';
                pointElement.style.top = pointY + 'px';
                pointElement.style.zIndex = '3';
                if (point.reached) {
                    pointElement.style.background = '#45b7aa';
                }
                minimap.appendChild(pointElement);
            });
            
            // –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞
            minimapPlayer.style.left = centerX + 'px';
            minimapPlayer.style.top = centerY + 'px';
            minimapPlayer.style.zIndex = '4';
            minimap.appendChild(minimapPlayer);
            
            // –ü–æ–∑–∏—Ü–∏—è —Ç–µ–∫—É—â–µ–π —Ü–µ–ª–∏
            if (gameState.currentTarget) {
                const targetX = centerX + gameState.currentTarget.x * scale;
                const targetY = centerY - gameState.currentTarget.z * scale;
                
                minimapTarget.style.left = targetX + 'px';
                minimapTarget.style.top = targetY + 'px';
                minimapTarget.style.zIndex = '5';
                minimapTarget.style.background = '#ff6b6b';
                minimapTarget.style.border = '2px solid white';
                minimap.appendChild(minimapTarget);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            pointsReached.textContent = gameState.pointsReached;
            
            if (gameState.startTime) {
                gameState.gameTime = Math.floor((Date.now() - gameState.startTime) / 1000);
                const minutes = Math.floor(gameState.gameTime / 60);
                const seconds = gameState.gameTime % 60;
                gameTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
        function endGame() {
            gameState.isRunning = false;
            startGame.disabled = false;
            pauseGame.disabled = true;
            
            navStatus.textContent = 'üèÜ –í—Å–µ —Ü–µ–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã!';
            navStatus.className = 'navigation-status reached';
            
            alert(`üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –≤—Å–µ—Ö —Ü–µ–ª–µ–π –∑–∞ ${gameTime.textContent}!`);
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞—É–∑—ã
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            pauseGame.textContent = gameState.isPaused ? '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏Ô∏è –ü–∞—É–∑–∞';
            navStatus.textContent = gameState.isPaused ? '‚è∏Ô∏è –ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ' : 'üèÉ‚Äç‚ôÇÔ∏è –ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è';
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            updateGameState();
            render3D();
            updateStats();
            requestAnimationFrame(gameLoop);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        audioToggle.addEventListener('click', () => {
            const isOn = toggleAudio();
            audioToggle.textContent = isOn ? 'üîä –û—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫' : 'üîá –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
            audioToggle.className = `audio-toggle ${isOn ? 'active' : ''}`;
        });
        
        startGame.addEventListener('click', () => {
            gameState.isRunning = true;
            gameState.isPaused = false;
            gameState.startTime = Date.now();
            gameState.lastDistance = null;
            
            startGame.disabled = true;
            pauseGame.disabled = false;
            
            navStatus.textContent = 'üèÉ‚Äç‚ôÇÔ∏è –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!';
            navStatus.className = 'navigation-status navigating';
            
            updateAvailableDirections();
            updateNavigation();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const statsInterval = setInterval(() => {
                if (!gameState.isRunning) {
                    clearInterval(statsInterval);
                    return;
                }
                updateStats();
            }, 1000);
        });
        
        pauseGame.addEventListener('click', togglePause);
        
        resetGame.addEventListener('click', () => {
            gameState = {
                isRunning: false,
                isPaused: false,
                currentTarget: null,
                playerPosition: { x: 0, y: 0, z: 0 },
                playerRotation: { x: 0, y: 0 },
                trails: [],
                targetPoints: [],
                pointsReached: 0,
                startTime: null,
                gameTime: 0,
                lastDistance: null,
                navigationActive: false,
                availableDirections: []
            };
            
            startGame.disabled = false;
            pauseGame.disabled = true;
            pauseGame.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
            
            navStatus.textContent = '–ì–æ—Ç–æ–≤ –∫ —Å—Ç–∞—Ä—Ç—É';
            navStatus.className = 'navigation-status';
            
            initGame();
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            initCanvas();
            initGame();
            gameLoop();
            console.log('üéÆ 3D –ò–≥—Ä–∞-—Å–∏–º—É–ª—è—Ç–æ—Ä –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        });
    </script>
</body>
</html>
